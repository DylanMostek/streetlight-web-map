import{gz as S,jX as _,jY as v,jZ as j,a8 as z,aa as E}from"./index-CCjLDPmS.js";import{f as y,d as $}from"./dataUtils-DqyXFlGe.js";function T(e,a,t){const{extent:r,valid:u}=e,[n,l,i,s]=r;return!(t<l||t>s)&&(u!=null&&n>i?a>=i||a<=n:a>=n&&a<=i)}function b(e,a,t,r){const{extent:u,modelSize:n,valid:l}=e,[i,s,c]=u,f=k(i,c,l);let o=a/n[0]*f+i;return l!=null&&r&&(o=new S(l[0],l[1]).normalize(o)),[o,(n[1]-t)/n[1]*_(u)+s]}function k(e,a,t){if(t!=null&&e>a){const[r,u]=t;return u-e+(a-r)}return a-e}function A(e){return e?4:3}function F(e,a,t){const[r,u]=t.modelSize;let n=null;const l=new Map;a.forEach(s=>{l.set(s.lij,y(e,s))});const i=(s,c,f)=>j(s.extent,c,f);return(s,c)=>{const f=Math.round(s),o=Math.round(c);if(!e.wrapAround&&(f<0||f>=r||o<0||o>=u))return[0,0];const[d,h]=b(t,s,c,!0);if(!T(t,d,h))return[0,0];if(n==null||!i(n,d,h)){n=null;for(const[I,x]of a)if(i(x,d,h)){n=x;break}}if(n?.data==null)return[0,0];const g=l.get(n.lij);if(g==null)return[0,0];const{width:M,height:w,extent:p}=n;return g((d-p[0])/v(p)*M,w-(h-p[1])/_(p)*w)}}let m=class{constructor(){this._tileData=new Map}async generateStreamlines(e){const{flowData:a,flowExtentInfo:t,needsMagnitude:r,simulationSettings:u,startPositions:n}=e,l=D(y(u,a),u,t.modelSize,r,n);return{result:{streamlines:l},transferList:l?.map(i=>i.vertices.buffer)}}async generateTiledStreamlines(e){const{flowDataTiles:a,flowExtentInfo:t,needsMagnitude:r,reset:u,simulationSettings:n,startPositions:l}=e;this._updateTileData(a,u);const i=D(F(n,this._tileData,t),n,t.modelSize,r,l);return{result:{streamlines:i},transferList:i?.map(s=>s.vertices.buffer)??[]}}_updateTileData(e,a){a&&this._tileData.forEach((t,r)=>{e.get(r)==null&&this._tileData.delete(r)}),e.forEach((t,r)=>{t.type==="delete"?this._tileData.delete(r):t.type!=="on-worker"&&t.type!=="waiting"&&this._tileData.set(r,t.data)})}};m=z([E("esri.views.3d.support.flow.FlowWorker")],m);const W=m;function D(e,a,t,r,u){if(e==null)return;const n=$(a,e,t[0],t[1],{positions:u}),l=[],i=A(r);for(const{vertices:s,stage:c}of n){const f=new Float32Array(s.length*i);for(let o=0;o<s.length;o++)f[o*i]=s[o].x,f[o*i+1]=s[o].y,f[o*i+2]=s[o].t,r&&(f[o*i+3]=s[o].speed);l.push({vertices:f,stage:c,hasMagnitude:r})}return l}export{W as default};
